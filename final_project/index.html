<!DOCTYPE html>
<html>
    <head>
    <title>Final Project: Indian Pollution Data</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.4/dist/leaflet.css" crossorigin />
    <script src="https://unpkg.com/leaflet@1.3.4/dist/leaflet.js" crossorigin=""></script>    
    <script src="https://dsps.lib.uiowa.edu/placing/public/leafletSlider-1.0.2/leaflet.SliderControl.min.js"></script>
    <script src="https://dsps.lib.uiowa.edu/placing/public/fuse-1.2.1/fuse.min.js"></script>
    <script src="https://dsps.lib.uiowa.edu/placing/public/leafletFuseSearch-noVersion/leafletfuse.js"></script>
    <link rel="stylesheet" href="https://dsps.lib.uiowa.edu/placing/public/leafletFuseSearch-noVersion/leafletfuse.css" type="text/css"/>
    <script src="https://code.jquery.com/jquery-1.9.1.min.js"></script>
    <script src="https://code.jquery.com/ui/1.9.2/jquery-ui.js"></script>
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.9.2/themes/base/jquery-ui.css" type="text/css">
    <style>
        html, body { margin: 0; padding: 0; height: 100%; }
        #map { height: 100%; }
    </style>
    <!-- <script src="/Users/clark/Desktop/WebMapping/FinalProject/Indian_States.js"></script>
    <script src="/Users/clark/Desktop/WebMapping/FinalProject/indian-cities.js"></script>
    <script src="/Users/clark/Desktop/WebMapping/FinalProject/in.js"></script>
    <script src="/Users/clark/Desktop/WebMapping/FinalProject/chronological.js"></script> -->

     <script src="https://clarkkovacs.github.io/final_project/Indian_States.js"></script>
    <script src="https://clarkkovacs.github.io/final_project/indian-cities.js"></script>
    <script src="https://clarkkovacs.github.io/final_project/in.js"></script>
    <script src="https://clarkkovacs.github.io/final_project/chronological.js"></script>
</head>
    </head>

    <body>
        <div id="map"></div>
        <script type="text/javascript">
    
            var map = L.map('map', {
                center: [20.5937, 78.9629],
                zoom: 5
            });
    
            L.tileLayer('https://stamen-tiles-{s}.a.ssl.fastly.net/tonerlite/{z}/{x}/{y}{r}.{ext}', {
                attribution: 'Map tiles by <a href="http://stamen.com">StamenDesign</a>, <a href="http://creativecommons.org/licenses/by/3.0">CC BY3.0</a> &mdash; Map data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                subdomains: 'abcd',
                minZoom: 0,
                maxZoom: 20,
                ext: 'png'
            }).addTo(map);
    
            var imagery = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community'
            });
    
            var layer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Terrain_Base/MapServer/tile/{z}/{y}/{x}', {
                attribution: 'Tiles &copy; Esri &mdash; Source: USGS, Esri, TANA, DeLorme, and NPS',
                maxZoom: 13
            }).addTo(map);
    
            function getColorForPM25(pm25) {
                if (pm25 === null) return '#cccccc'; // Grey for no data
                return pm25 > 250 ? '#800026' :
                    pm25 > 150 ? '#BD0026' :
                    pm25 > 100 ? '#E31A1C' :
                    pm25 > 50 ? '#FC4E2A' :
                    pm25 > 30 ? '#FD8D3C' :
                    pm25 > 20 ? '#FEB24C' :
                    pm25 > 10 ? '#FED976' :
                    '#FFEDA0';
            }
    
            function style_states(feature) {
                return {
                    fillColor: 'black',
                    weight: 3,
                    opacity: 1,
                    color: 'black',
                    fillOpacity: 0
                };
            }
    
            function style_cities(feature) {
                return {
                    fillColor: 'white',
                    weight: 1,
                    opacity: 1,
                    color: 'black',
                    fillOpacity: 0
                };
            }
    
            var city_shapes = new L.geoJson(city_shapes, { style: style_cities }).addTo(map);
            var states = new L.geoJson(states, { style: style_states }).addTo(map);

            // Convert dates to a consistent format (ISO 8601)
            chrono.forEach(function(feature) {
                var dateParts = feature.properties.Date.split('/');
                var formattedDate = '20' + dateParts[2] + '-' + ('0' + dateParts[0]).slice(-2) + '-' + ('0' + dateParts[1]).slice(-2);
                feature.properties.Date = formattedDate;
            });


            var onEachFeature = function (feature, layer) {
            if (feature.properties) {
                var popupContent = '<h3>' + feature.properties.City + '</h3>' +
                    '<p>Date: ' + feature.properties.Date + '<br>NO: ' +
                    (feature.properties["NO"] === null ? "Data not available" : feature.properties["NO"]) + '</p>';
                layer.bindPopup(popupContent, { maxWidth: "auto" });
            }
        };

        var timelineLayer = L.geoJson(chrono, {
            onEachFeature: onEachFeature,
            pointToLayer: function (feature, latlng) {
                return L.circleMarker(latlng, {
                    radius: feature.properties["NO"] === null ? 4 : Math.sqrt(feature.properties["NO"]) * 10,
                    color: getColorForPM25(feature.properties["NO"]),
                    fillColor: getColorForPM25(feature.properties["NO"]),
                    fillOpacity: 1
                });
            }
        });

        var sliderControl = L.control.sliderControl({
            position: "bottomleft",
            layer: timelineLayer,
            timeAttribute: 'Date',
            range: false,
            follow: true // ensures the slider updates the map view to the current time point
        });

        map.addControl(sliderControl);
        sliderControl.startSlider(); // initialize

        var baseMaps = {
            "Terrain": layer,
            "Satellite": imagery
        };

        var overlayMaps = {
            "States": states,
            "City Shapes": city_shapes
        };

        L.control.layers(baseMaps, overlayMaps, { collapsed: false }).addTo(map);

    </script>
</body>
</html>